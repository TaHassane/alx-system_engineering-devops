#!/usr/bin/env bash
# Bash script to install Nginx on a new Ubuntu machine and configure it to meet specific requirements.

# Update package lists and install Nginx
sudo apt-get update -y -qq && sudo apt-get install nginx -y

# Check if Nginx is installed
if ! [ -x "$(command -v nginx)" ]; then
  echo 'Error: Nginx installation failed.' >&2
  exit 1
fi

# Configure Nginx to listen on port 80
sudo sed -i 's/listen 80 default_server;/listen 80;/g' /etc/nginx/sites-available/default

# Restart Nginx
sudo service nginx restart

# Check if Nginx is running
if ! sudo systemctl is-active --quiet nginx; then
  echo 'Error: Nginx failed to start.' >&2
  exit 1
fi

# Create a simple "Hello World" page
echo "Hello World!" | sudo tee /var/www/html/index.html > /dev/null

# Test if the "Hello World" page is served correctly
curl -s localhost | grep -q "Hello World!"
if [ $? -eq 0 ]; then
  echo "Nginx is configured successfully. Hello World page is served."
else
  echo "Error: Failed to verify Nginx configuration." >&2
  exit 1
fi

echo "Setup completed successfully."
